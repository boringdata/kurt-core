# Answer

## How to Set Up MotherDuck to Work with dbt

Setting up MotherDuck with dbt involves installing the dbt-duckdb adapter, configuring your profiles.yml, and authenticating with your MotherDuck token. Here's the complete setup process:

### 1. Prerequisites

- Sign up for a MotherDuck account at [motherduck.com](https://motherduck.com)
- Get your Service Token from the MotherDuck UI (Settings > Service Token)

### 2. Install the dbt-duckdb Adapter

The dbt-duckdb adapter (created by Josh Wills) works with both DuckDB and MotherDuck:

```bash
python3 -m venv venv
source venv/bin/activate
python3 -m pip install dbt-duckdb
```

### 3. Configure Your profiles.yml

Create or edit your `~/.dbt/profiles.yml` file. The key is using the `md:` prefix in the `path` parameter to connect to MotherDuck:

**Basic Configuration:**
```yaml
your_project:
  target: dev
  outputs:
    dev:
      type: duckdb
      schema: dev_yourname
      path: 'md:your_database_name'
      threads: 16
```

**Dual Execution (Local Dev + Cloud Prod):**
```yaml
dual_execution:
  outputs:
    local:
      type: duckdb
      path: local.db
      attach:
        - path: "md:"  # attaches all MotherDuck databases
    prod:
      type: duckdb
      path: "md:your_database"
  target: local
```

**With S3 Integration:**
```yaml
your_project:
  target: dev
  outputs:
    dev:
      type: duckdb
      schema: dev_yourname
      path: 'md:your_database'
      threads: 16
      extensions:
        - httpfs
      settings:
        s3_region: "{{ env_var('S3_REGION', 'us-west-1') }}"
        s3_access_key_id: "{{ env_var('S3_ACCESS_KEY_ID') }}"
        s3_secret_access_key: "{{ env_var('S3_SECRET_ACCESS_KEY') }}"
```

### 4. Set Environment Variables

Export your MotherDuck token (and S3 credentials if needed):

```bash
export motherduck_token=<your_motherduck_token>
export S3_REGION=<your_region>  # if using S3
export S3_ACCESS_KEY_ID=<your_access_key>  # if using S3
export S3_SECRET_ACCESS_KEY=<your_secret>  # if using S3
```

### 5. Verify Connection

```bash
dbt debug
```

### 6. Run Your Project

```bash
dbt build
```

### Advanced: Conditional Sampling for Local Development

You can use the `target` variable in your models to sample data when running locally:

```sql
from {{ source("your_source", "large_table") }}
{% if target.name == 'local' %} using sample 1 % {% endif %}
```

### Key Benefits

- **Fast iterations**: dbt runs can drop from hours to minutes using local DuckDB for development
- **Dual execution**: Run development locally while production runs in the cloud
- **S3 integration**: Query data directly from S3 without copying it
- **Approximately 5x faster** dbt runs by minimizing local data size and optimizing compute resources

## Sources

- .kurt/sources/motherduck.com/blog/motherduck-duckdb-dbt.md - Comprehensive tutorial on setting up MotherDuck with dbt, including profiles.yml configuration, environment variables, and S3 integration
- .kurt/sources/motherduck.com/blog/dual-execution-dbt.md - Guide for dual execution setup (local dev + cloud prod) with profile configuration and sampling strategies
