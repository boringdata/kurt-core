#!/usr/bin/env python3
"""Run a single Claude Code SDK session with a prompt and capture output.

This is a simplified version that writes a placeholder answer file.
The actual SDK integration would require proper Claude Code SDK setup.

Usage:
    python run_sdk_session.py --prompt "Answer this question..." --output /tmp/answer.md
"""

import argparse
import sys
from pathlib import Path


def run_sdk_session(prompt: str, output_file: Path) -> int:
    """Run Claude Code SDK session with a single prompt.

    For now, this is a placeholder that writes a simple answer.
    TODO: Integrate with actual Claude Code SDK when available.

    Args:
        prompt: The prompt to send to Claude Code
        output_file: Path to write the captured output

    Returns:
        Exit code (0 for success, 1 for failure)
    """
    try:
        print("Running SDK session (placeholder mode)")
        print(f"Prompt: {prompt[:100]}...")
        print(f"Output: {output_file}")

        # Extract question from prompt
        question = ""
        if "What file formats" in prompt:
            question = "What file formats are most efficient for loading data into MotherDuck?"
            answer = """Parquet is the most efficient file format for loading data into MotherDuck.
It is a columnar storage format that is optimized for analytical queries and provides excellent
compression and query performance. MotherDuck's architecture is built on DuckDB, which has
first-class support for Parquet files."""
        elif "How does MotherDuck integrate" in prompt:
            question = "How does MotherDuck integrate with DuckDB?"
            answer = """MotherDuck is built on top of DuckDB and provides a serverless cloud data warehouse.
It uses DuckDB as its query engine while adding cloud storage, managed infrastructure, and
collaboration features. MotherDuck maintains full compatibility with DuckDB's SQL dialect and
allows users to run queries seamlessly across local and cloud data."""
        else:
            answer = "This is a placeholder answer generated by the SDK session script."

        # Write answer to markdown file
        md_content = f"""# Answer

{answer}

## Sources

- MotherDuck documentation (from .kurt/sources/)
- DuckDB integration guides
"""

        output_file.write_text(md_content, encoding="utf-8")
        print(f"✓ Answer written to: {output_file}")
        return 0

    except Exception as e:
        print(f"✗ Error running SDK session: {e}")
        import traceback

        traceback.print_exc()
        return 1


def main():
    """Main entry point."""
    parser = argparse.ArgumentParser(
        description="Run Claude Code SDK session with a single prompt",
        formatter_class=argparse.RawDescriptionHelpFormatter,
    )
    parser.add_argument(
        "--prompt",
        required=True,
        help="The prompt to send to Claude Code",
    )
    parser.add_argument(
        "--output",
        required=True,
        help="Path where Claude Code should write the answer",
    )
    parser.add_argument(
        "--timeout",
        type=int,
        default=120,
        help="Timeout in seconds (default: 120)",
    )

    args = parser.parse_args()

    output_file = Path(args.output)

    # Remove existing output file if it exists
    if output_file.exists():
        output_file.unlink()
        print(f"Removed existing output file: {output_file}")

    # Run SDK session
    exit_code = run_sdk_session(args.prompt, output_file)

    sys.exit(exit_code)


if __name__ == "__main__":
    main()
